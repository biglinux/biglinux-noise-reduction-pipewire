#!/bin/bash
# Noise Reduction Filter Control Script
# Thin wrapper around the Python CLI module

# Find Python site-packages with our module
find_pythonpath() {
	for sitepkg in /usr/lib/python*/site-packages; do
		if [[ -d "$sitepkg/biglinux_microphone" ]]; then
			echo "$sitepkg"
			return 0
		fi
	done
	return 1
}

# Bluetooth policy file
bluetooth_policy="$HOME/.config/wireplumber/wireplumber.conf.d/11-bluetooth-policy.conf"

case "$1" in
start | stop | status)
	PYTHONPATH=$(find_pythonpath) || {
		echo "Error: biglinux_microphone module not found" >&2
		exit 1
	}
	export PYTHONPATH
	exec python3 -m biglinux_microphone.cli "$1"
	;;

enable-bluetooth-autoswitch-to-headset)
	mkdir -p "$(dirname "$bluetooth_policy")"
	echo 'wireplumber.settings = {
    bluetooth.autoswitch-to-headset-profile = true
}' >"$bluetooth_policy"
	systemctl --user restart wireplumber
	;;

disable-bluetooth-autoswitch-to-headset)
	mkdir -p "$(dirname "$bluetooth_policy")"
	echo 'wireplumber.settings = {
    bluetooth.autoswitch-to-headset-profile = false
}' >"$bluetooth_policy"
	systemctl --user restart wireplumber
	;;

status-bluetooth)
	if [[ -e "$bluetooth_policy" ]] && grep -q 'bluetooth.autoswitch-to-headset-profile = false' "$bluetooth_policy"; then
		echo "disabled"
		exit 1
	else
		echo "enabled"
		exit 0
	fi
	;;

*)
	echo "Usage: $0 {start|stop|status|enable-bluetooth-autoswitch-to-headset|disable-bluetooth-autoswitch-to-headset|status-bluetooth}"
	;;
esac
