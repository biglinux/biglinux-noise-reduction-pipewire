#!/bin/bash

# Set localization environment variables
export TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAIN=biglinux-noise-reduction-pipewire

# Define the name of the noise-free microphone
mic_name=$"Reduce Microphone Noise"
config_path_old="$HOME/.config/pipewire/filter-chain.conf.d/source-rnnoise.conf"
config_path="$HOME/.config/pipewire/filter-chain.conf.d/source-rnnoise-smart.conf"
system_file="/usr/share/pipewire/filter-chain/source-rnnoise-smart.conf"

# Update to new version ( 07/07/2024 )
if [[ -e "$config_path_old" ]]; then
    rm -f "$config_path_old"
    cp "$system_file"
fi

# Check for the first argument to determine the action (start or stop)
if [ "$1" = "start" ]; then
    # Send a notification to indicate activation
    notify-send $"Activated!" --app-name="$mic_name"

    # Check if the configuration file exists
    if [ ! -e "$config_path" ]; then
        # Create the directory if it doesn't exist
        mkdir -p ~/.config/pipewire/filter-chain.conf.d

        # Copy the configuration file
        cp -f "$system_file" "$config_path"
    fi

    # Start the noise reduction services
    /usr/bin/pipewire -c filter-chain.conf

elif [ "$1" = "stop" ]; then
    # Send a notification to indicate deactivation
    notify-send $"Disabled!" --app-name="$mic_name"

    # Remove the configuration file
    rm -f "$config_path"

    # Find and kill the pipewire process
    pipewirePidFiltered=$(ps -aux | grep '/usr/bin/pipewire -c filter-chain.conf' | awk '{ print $2 }')
    for pid in $pipewirePidFiltered; do
        kill $pid
    done

elif [ "$1" = "status" ]; then
    # Check if the configuration file exists
    if [ -e "$config_path" ]; then
        echo "enabled"
        exit 0
    else
        echo "disabled"
        exit 1
    fi
else
    # Print usage information if no valid argument is provided
    echo "Usage: $0 {start|stop|status}"
fi
