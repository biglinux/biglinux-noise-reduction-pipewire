#!/bin/bash

# Set localization environment variables
export TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAIN=biglinux-noise-reduction-pipewire

# =============================================================================
# Configuration Paths
# =============================================================================

# Define the name of the noise-free microphone
mic_name=$"Reduce Microphone Noise"

# Legacy paths (for migration)
config_path_old="$HOME/.config/pipewire/filter-chain.conf.d/source-rnnoise.conf"
config_path_rnnoise="$HOME/.config/pipewire/filter-chain.conf.d/source-rnnoise-smart.conf"

# New GTCRN paths
config_path="$HOME/.config/pipewire/filter-chain.conf.d/source-gtcrn-smart.conf"
system_file="/usr/share/pipewire/filter-chain/source-gtcrn-smart.conf"

# User settings file
settings_file="$HOME/.config/biglinux-noise-reducer/settings.json"
bluetooth_policy="$HOME/.config/wireplumber/wireplumber.conf.d/11-bluetooth-policy.conf"

# =============================================================================
# Migration from old versions
# =============================================================================

# Remove old rnnoise configs if they exist
if [[ -e "$config_path_old" ]]; then
	rm -f "$config_path_old"
fi

if [[ -e "$config_path_rnnoise" ]]; then
	rm -f "$config_path_rnnoise"
fi

# =============================================================================
# Model and Strength Configuration
# =============================================================================

# Model types: 0 = GTCRN Simple (lower latency), 1 = GTCRN Full (best quality)
DEFAULT_MODEL=0
DEFAULT_STRENGTH=1.0

# Gate filter defaults (matching system config)
DEFAULT_GATE_ENABLED=1
DEFAULT_GATE_THRESHOLD=-36
DEFAULT_GATE_ATTACK=10
DEFAULT_GATE_HOLD=200
DEFAULT_GATE_DECAY=60
DEFAULT_GATE_RANGE=-6

# Get current model setting from user config
get_model() {
	if [[ -e "$settings_file" ]]; then
		model=$(grep -oP '"model"\s*:\s*\K[0-9]+' "$settings_file" 2>/dev/null)
		if [[ -n "$model" ]]; then
			echo "$model"
			return
		fi
	fi
	echo "$DEFAULT_MODEL"
}

# Get current strength setting from user config
get_strength() {
	if [[ -e "$settings_file" ]]; then
		strength=$(grep -oP '"strength"\s*:\s*\K[0-9.]+' "$settings_file" 2>/dev/null)
		if [[ -n "$strength" ]]; then
			echo "$strength"
			return
		fi
	fi
	echo "$DEFAULT_STRENGTH"
}

# Get gate enabled setting from user config
get_gate_enabled() {
	if [[ -e "$settings_file" ]]; then
		enabled=$(grep -oP '"gate_enabled"\s*:\s*\K(true|false|[0-9]+)' "$settings_file" 2>/dev/null)
		if [[ -n "$enabled" ]]; then
			[[ "$enabled" == "true" || "$enabled" == "1" ]] && echo "1" || echo "0"
			return
		fi
	fi
	echo "$DEFAULT_GATE_ENABLED"
}

# Get gate threshold setting from user config
get_gate_threshold() {
	if [[ -e "$settings_file" ]]; then
		value=$(grep -oP '"gate_threshold"\s*:\s*\K-?[0-9]+' "$settings_file" 2>/dev/null)
		if [[ -n "$value" ]]; then
			echo "$value"
			return
		fi
	fi
	echo "$DEFAULT_GATE_THRESHOLD"
}

# Get gate range setting from user config
get_gate_range() {
	if [[ -e "$settings_file" ]]; then
		value=$(grep -oP '"gate_range"\s*:\s*\K-?[0-9]+' "$settings_file" 2>/dev/null)
		if [[ -n "$value" ]]; then
			echo "$value"
			return
		fi
	fi
	echo "$DEFAULT_GATE_RANGE"
}

# Get stereo widen setting (true/false)
get_stereo_widen() {
	if [[ -e "$settings_file" ]]; then
		value=$(grep -oP '"stereo_widen":\s*\K(true|false)' "$settings_file" 2>/dev/null)
		if [[ -n "$value" ]]; then
			echo "$value"
			return
		fi
	fi
	echo "false" # Default off
}

# Get stereo delay setting (ms)
get_stereo_delay() {
	if [[ -e "$settings_file" ]]; then
		value=$(grep -oP '"stereo_delay":\s*\K[0-9]+' "$settings_file" 2>/dev/null)
		if [[ -n "$value" ]]; then
			echo "$value"
			return
		fi
	fi
	echo "20" # Default 20ms
}

# Update PipeWire config with current model, strength, and gate settings
update_config() {
	local model=$(get_model)
	local strength=$(get_strength)
	local gate_threshold=$(get_gate_threshold)
	local gate_range=$(get_gate_range)

	# Ensure config directory exists
	mkdir -p "$(dirname "$config_path")"

	# Remove old config files to avoid conflicts
	if [[ -e "$config_path_old" ]]; then
		rm -f "$config_path_old"
	fi

	if [[ -e "$config_path_rnnoise" ]]; then
		rm -f "$config_path_rnnoise"
	fi

	# Copy system file and update control values
	cp -f "$system_file" "$config_path"

	# Update Model value in config
	sed -i "s/\"Model\" = [0-9.]*$/\"Model\" = ${model}.0/" "$config_path"

	# Update Strength value in config
	sed -i "s/\"Strength\" = [0-9.]*$/\"Strength\" = ${strength}/" "$config_path"

	# Update Gate Threshold value in config
	sed -i "s/\"Threshold (dB)\" = -\?[0-9]*$/\"Threshold (dB)\" = ${gate_threshold}/" "$config_path"

	# Update Gate Range value in config
	sed -i "s/\"Range (dB)\" = -\?[0-9]*$/\"Range (dB)\" = ${gate_range}/" "$config_path"

	# Update Stereo settings
	local widen=$(get_stereo_widen)
	local delay_ms=$(get_stereo_delay)
	local delay_s=0.0
	if [[ "$widen" == "true" ]]; then
		# Convert ms to seconds
		delay_s=$(awk "BEGIN {print $delay_ms/1000}")
	fi

	# Update Delay Time
	sed -i "s/\"Delay Time (s)\" = [0-9.]*$/\"Delay Time (s)\" = ${delay_s}/" "$config_path"
}

# =============================================================================
# Live Parameter Updates (via pw-cli)
# =============================================================================

# Get the filter-chain input node ID for live updates
# This node exposes all LADSPA plugin parameters (gtcrn:*, gate:*)
get_filter_chain_node_id() {
	# Find the input.filter-chain node which has all the params exposed
	local node_id=""

	# Method 1: Find by node.name containing input.filter-chain
	node_id=$(pw-dump 2>/dev/null | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    for obj in data:
        if obj.get('type') == 'PipeWire:Interface:Node':
            props = obj.get('info', {}).get('props', {})
            name = props.get('node.name', '')
            if 'input.filter-chain' in name:
                params = obj.get('info', {}).get('params', {})
                prop_info = params.get('PropInfo', [])
                # Check if this node has gtcrn params
                for p in prop_info:
                    if 'gtcrn:' in str(p.get('name', '')):
                        print(props.get('object.id', ''))
                        break
except: pass
" 2>/dev/null | head -1)

	# Method 2: Simpler grep fallback
	if [[ -z "$node_id" ]]; then
		node_id=$(pw-dump 2>/dev/null | grep -B30 'gtcrn:Strength' | grep '"object.id":' | tail -1 | grep -oP '\d+')
	fi

	echo "$node_id"
}

# Update strength parameter live without restarting filter-chain
update_strength_live() {
	local strength="$1"
	local node_id=$(get_filter_chain_node_id)

	if [[ -z "$node_id" ]]; then
		echo "Warning: Could not find filter-chain node for live update" >&2
		return 1
	fi

	# Update the gtcrn:Strength control parameter
	# Note: parameter name must include the LADSPA node name prefix
	pw-cli set-param "$node_id" Props "{ params = [ \"gtcrn:Strength\" $strength ] }" 2>/dev/null

	return $?
}

# Update model parameter live without restarting filter-chain
update_model_live() {
	local model="$1"
	local node_id=$(get_filter_chain_node_id)

	if [[ -z "$node_id" ]]; then
		echo "Warning: Could not find filter-chain node for live update" >&2
		return 1
	fi

	# Update the gtcrn:Model control parameter
	# Note: parameter name must include the LADSPA node name prefix
	pw-cli set-param "$node_id" Props "{ params = [ \"gtcrn:Model\" ${model}.0 ] }" 2>/dev/null

	return $?
}

# Update gate threshold parameter live without restarting filter-chain
update_gate_threshold_live() {
	local threshold="$1"
	# Gate params are on the same node as gtcrn params
	local node_id=$(get_filter_chain_node_id)

	if [[ -z "$node_id" ]]; then
		echo "Warning: Could not find filter-chain node for live update" >&2
		return 1
	fi

	# Update the gate:Threshold (dB) control parameter
	# Note: parameter name must include the LADSPA node name prefix
	pw-cli set-param "$node_id" Props "{ params = [ \"gate:Threshold (dB)\" $threshold ] }" 2>/dev/null

	return $?
}

# Update gate range parameter live without restarting filter-chain
update_gate_range_live() {
	local range="$1"
	local node_id=$(get_filter_chain_node_id)

	if [[ -z "$node_id" ]]; then
		echo "Warning: Could not find filter-chain node for live update" >&2
		return 1
	fi

	# Update the gate:Range (dB) control parameter
	pw-cli set-param "$node_id" Props "{ params = [ \"gate:Range (dB)\" $range ] }" 2>/dev/null

	return $?
}

# Update stereo widen parameter live
# Update stereo widen parameter live
update_stereo_widen_live() {
	local widen="$1"
	local delay_ms=$(get_stereo_delay)
	local delay_s=0.0

	if [[ "$widen" == "true" ]]; then
		delay_s=$(awk "BEGIN {print $delay_ms/1000}")
	fi

	local node_id=$(get_filter_chain_node_id)
	if [[ -z "$node_id" ]]; then
		return 1
	fi

	pw-cli set-param "$node_id" Props "{ params = [ \"delay:Delay Time (s)\" $delay_s ] }" 2>/dev/null
	return $?
}

# Update stereo delay parameter live
update_stereo_delay_live() {
	local delay_ms="$1"
	local widen=$(get_stereo_widen)

	# Only apply if widen is enabled
	if [[ "$widen" != "true" ]]; then
		return 0
	fi

	# Convert to seconds
	local delay_s=$(awk "BEGIN {print $delay_ms/1000}")
	local node_id=$(get_filter_chain_node_id)

	if [[ -z "$node_id" ]]; then
		return 1
	fi

	pw-cli set-param "$node_id" Props "{ params = [ \"delay:Delay Time (s)\" $delay_s ] }" 2>/dev/null
	return $?
}

# =============================================================================
# Helper Functions
# =============================================================================

# Get the filter-chain source name
get_filter_source() {
	# Try multiple patterns to find the filter-chain source
	local source_name=""

	# Pattern 1: Look for output.filter-chain (traditional)
	source_name=$(pactl list sources short 2>/dev/null | grep -o 'output\.filter-chain[[:alnum:]_.-]*' | head -1)

	# Pattern 2: Look for big.filter-microphone (smart filter name)
	if [[ -z "$source_name" ]]; then
		source_name=$(pactl list sources short 2>/dev/null | grep -o 'big\.filter-microphone[[:alnum:]_.-]*' | head -1)
	fi

	# Pattern 3: Look for any filter-chain source
	if [[ -z "$source_name" ]]; then
		source_name=$(pactl list sources short 2>/dev/null | grep 'filter-chain' | awk '{print $2}' | head -1)
	fi

	# Pattern 4: Look for Noise Canceling Microphone by description
	if [[ -z "$source_name" ]]; then
		source_name=$(pactl list sources 2>/dev/null | grep -B 5 "Noise Canceling Microphone" | grep "Name:" | awk '{print $2}' | head -1)
	fi

	echo "$source_name"
}

# Set source volume and unmute with proper error handling
configure_filter_source() {
	local source_name=$(get_filter_source)

	if [[ -z "$source_name" ]]; then
		echo "Warning: Could not find filter-chain source" >&2
		return 1
	fi

	echo "Found filter source: $source_name" >&2

	# Unmute and set volume
	pactl set-source-mute "$source_name" 0 2>/dev/null
	pactl set-source-volume "$source_name" 100% 2>/dev/null

	return 0
}

# =============================================================================
# Main Actions
# =============================================================================

# Check for the first argument to determine the action (start, stop, status, etc.)
case "$1" in
start)
	# Find and kill the pipewire process
	pipewirePidFiltered=$(ps -aux | grep '/usr/bin/[p]ipewire -c filter-chain.conf' | awk '{ print $2 }')
	for pid in $pipewirePidFiltered; do
		kill $pid 2>/dev/null
	done

	# Only update config if it doesn't exist
	# (The Python GUI app generates its own config with stereo support)
	if [[ ! -e "$config_path" ]]; then
		update_config
	fi

	# Start the noise reduction services
	/usr/bin/pipewire -c filter-chain.conf &

	# Wait for the filter chain to initialize
	sleep 2

	# Configure the filter source
	configure_filter_source

	# Wait a bit more and try again to ensure stability
	sleep 2
	configure_filter_source

	wait
	;;

stop)
	# Remove the configuration file
	rm -f "$config_path"

	# Remove old config files to avoid conflicts
	if [[ -e "$config_path_old" ]]; then
		rm -f "$config_path_old"
	fi

	if [[ -e "$config_path_rnnoise" ]]; then
		rm -f "$config_path_rnnoise"
	fi

	# Find and kill the pipewire process
	pipewirePidFiltered=$(ps -aux | grep '/usr/bin/[p]ipewire -c filter-chain.conf' | awk '{ print $2 }')
	for pid in $pipewirePidFiltered; do
		kill $pid
	done
	;;

status)
	# Check if the configuration file exists
	if [ -e "$config_path" ]; then
		echo "enabled"
		exit 0
	else
		echo "disabled"
		exit 1
	fi
	;;

enable-bluetooth-autoswitch-to-headset)
	mkdir -p "$(dirname "$bluetooth_policy")"
	echo 'wireplumber.settings = {
    bluetooth.autoswitch-to-headset-profile = true
}' >"$bluetooth_policy"
	systemctl --user restart wireplumber
	;;

disable-bluetooth-autoswitch-to-headset)
	mkdir -p "$(dirname "$bluetooth_policy")"
	echo 'wireplumber.settings = {
    bluetooth.autoswitch-to-headset-profile = false
}' >"$bluetooth_policy"
	systemctl --user restart wireplumber
	;;

status-bluetooth)
	# Check if the configuration file exists
	if [[ -e "$bluetooth_policy" ]] && grep -q 'bluetooth.autoswitch-to-headset-profile = false' "$bluetooth_policy"; then
		echo "disabled"
		exit 1
	else
		echo "enabled"
		exit 0
	fi
	;;

get-model)
	# Return current model setting
	echo "$(get_model)"
	;;

set-model)
	# Set model type (0 = Simple/Low Latency, 1 = Full Quality)
	if [[ -z "$2" ]]; then
		echo "Error: Model value required (0 = Simple/Low Latency, 1 = Full Quality)"
		exit 1
	fi

	model_value="$2"

	# Validate model value
	if [[ "$model_value" != "0" && "$model_value" != "1" ]]; then
		echo "Error: Invalid model value. Use 0 (Simple/Low Latency) or 1 (Full Quality)"
		exit 1
	fi

	# Update settings file
	mkdir -p "$(dirname "$settings_file")"
	if [[ -e "$settings_file" ]]; then
		# Update existing model value or add it
		if grep -q '"model"' "$settings_file"; then
			sed -i "s/\"model\":\s*[0-9]*/\"model\": $model_value/" "$settings_file"
		else
			# Add model to existing JSON
			sed -i 's/}$/,\n    "model": '"$model_value"'}/' "$settings_file"
		fi
	else
		echo '{"model": '"$model_value"', "strength": 1.0}' >"$settings_file"
	fi

	# If noise reduction is running, try live update first
	if [[ -e "$config_path" ]]; then
		# Try live update via pw-cli (doesn't interrupt audio)
		if ! update_model_live "$model_value"; then
			# Fallback: update config file for next restart
			update_config
		fi
	fi

	echo "Model set to $model_value"
	;;

get-strength)
	# Return current strength setting
	echo "$(get_strength)"
	;;

set-strength)
	# Set noise reduction strength (0.0 - 1.0)
	if [[ -z "$2" ]]; then
		echo "Error: Strength value required (0.0 - 1.0)"
		exit 1
	fi

	strength_value="$2"

	# Validate strength value (basic check)
	if ! echo "$strength_value" | grep -qE '^[0-1](\.[0-9]+)?$'; then
		echo "Error: Invalid strength value. Use a value between 0.0 and 1.0"
		exit 1
	fi

	# Update settings file
	mkdir -p "$(dirname "$settings_file")"
	if [[ -e "$settings_file" ]]; then
		# Update existing strength value or add it
		if grep -q '"strength"' "$settings_file"; then
			sed -i "s/\"strength\":\s*[0-9.]*,/\"strength\": $strength_value,/" "$settings_file"
			sed -i "s/\"strength\":\s*[0-9.]*}/\"strength\": $strength_value}/" "$settings_file"
		else
			# Add strength to existing JSON
			sed -i 's/}$/,\n    "strength": '"$strength_value"'}/' "$settings_file"
		fi
	else
		echo '{"model": 0, "strength": '"$strength_value"'}' >"$settings_file"
	fi

	# If noise reduction is running, try live update first
	if [[ -e "$config_path" ]]; then
		# Try live update via pw-cli (doesn't interrupt audio)
		if ! update_strength_live "$strength_value"; then
			# Fallback: update config file for next restart
			update_config
		fi
	fi

	echo "Strength set to $strength_value"
	;;

get-gate-threshold)
	# Return current gate threshold setting
	echo "$(get_gate_threshold)"
	;;

set-gate-threshold)
	# Set gate threshold (-60 to 0 dB)
	if [[ -z "$2" ]]; then
		echo "Error: Threshold value required (-60 to 0)"
		exit 1
	fi

	threshold_value="$2"

	# Validate threshold value
	if ! echo "$threshold_value" | grep -qE '^-?[0-9]+$'; then
		echo "Error: Invalid threshold value. Use an integer between -60 and 0"
		exit 1
	fi

	# Clamp to valid range
	if ((threshold_value < -60)); then
		threshold_value=-60
	elif ((threshold_value > 0)); then
		threshold_value=0
	fi

	# Update settings file
	mkdir -p "$(dirname "$settings_file")"
	if [[ -e "$settings_file" ]]; then
		if grep -q '"gate_threshold"' "$settings_file"; then
			sed -i "s/\"gate_threshold\":\s*-\?[0-9]*/\"gate_threshold\": $threshold_value/" "$settings_file"
		else
			# Add gate_threshold to existing JSON
			sed -i 's/}$/,\n    "gate_threshold": '"$threshold_value"'}/' "$settings_file"
		fi
	else
		echo '{"model": 0, "strength": 1.0, "gate_threshold": '"$threshold_value"'}' >"$settings_file"
	fi

	# If noise reduction is running, try live update first
	if [[ -e "$config_path" ]]; then
		if ! update_gate_threshold_live "$threshold_value"; then
			update_config
		fi
	fi

	echo "Gate threshold set to ${threshold_value} dB"
	;;

get-gate-range)
	# Return current gate range setting
	echo "$(get_gate_range)"
	;;

set-gate-range)
	# Set gate range (-90 to 0 dB)
	if [[ -z "$2" ]]; then
		echo "Error: Range value required (-90 to 0)"
		exit 1
	fi

	range_value="$2"

	# Validate range value
	if ! echo "$range_value" | grep -qE '^-?[0-9]+$'; then
		echo "Error: Invalid range value. Use an integer between -90 and 0"
		exit 1
	fi

	# Clamp to valid range
	if ((range_value < -90)); then
		range_value=-90
	elif ((range_value > 0)); then
		range_value=0
	fi

	# Update settings file
	mkdir -p "$(dirname "$settings_file")"
	if [[ -e "$settings_file" ]]; then
		if grep -q '"gate_range"' "$settings_file"; then
			sed -i "s/\"gate_range\":\s*-\?[0-9]*/\"gate_range\": $range_value/" "$settings_file"
		else
			# Add gate_range to existing JSON
			sed -i 's/}$/,\n    "gate_range": '"$range_value"'}/' "$settings_file"
		fi
	else
		echo '{"model": 0, "strength": 1.0, "gate_range": '"$range_value"'}' >"$settings_file"
	fi

	# If noise reduction is running, try live update first
	if [[ -e "$config_path" ]]; then
		if ! update_gate_range_live "$range_value"; then
			update_config
		fi
	fi

	echo "Gate range set to ${range_value} dB"
	;;

get-stereo-widen)
	echo "$(get_stereo_widen)"
	;;

set-stereo-widen)
	# Set stereo widen (true/false)
	if [[ -z "$2" ]]; then
		echo "Error: value required (true/false)"
		exit 1
	fi

	widen_value="$2"
	if [[ "$widen_value" != "true" && "$widen_value" != "false" ]]; then
		echo "Error: Invalid value. Use true or false"
		exit 1
	fi

	# Update settings file
	mkdir -p "$(dirname "$settings_file")"
	if [[ -e "$settings_file" ]]; then
		if grep -q '"stereo_widen"' "$settings_file"; then
			sed -i "s/\"stereo_widen\":\s*\(true\|false\)/\"stereo_widen\": $widen_value/" "$settings_file"
		else
			sed -i 's/}$/,\n    "stereo_widen": '"$widen_value"'}/' "$settings_file"
		fi
	else
		echo '{"model": 0, "strength": 1.0, "stereo_widen": '"$widen_value"'}' >"$settings_file"
	fi

	# Try live update
	if [[ -e "$config_path" ]]; then
		if ! update_stereo_widen_live "$widen_value"; then
			update_config
		fi
	fi
	echo "Stereo widen set to $widen_value"
	;;

get-stereo-delay)
	echo "$(get_stereo_delay)"
	;;

set-stereo-delay)
	# Set stereo delay (0-1000 ms)
	if [[ -z "$2" ]]; then
		echo "Error: Delay value required (ms)"
		exit 1
	fi

	delay_value="$2"
	if ! echo "$delay_value" | grep -qE '^[0-9]+$'; then
		echo "Error: Invalid delay value. Use an integer (ms)"
		exit 1
	fi

	# Update settings file
	mkdir -p "$(dirname "$settings_file")"
	if [[ -e "$settings_file" ]]; then
		if grep -q '"stereo_delay"' "$settings_file"; then
			sed -i "s/\"stereo_delay\":\s*[0-9]*/\"stereo_delay\": $delay_value/" "$settings_file"
		else
			sed -i 's/}$/,\n    "stereo_delay": '"$delay_value"'}/' "$settings_file"
		fi
	else
		echo '{"model": 0, "strength": 1.0, "stereo_delay": '"$delay_value"'}' >"$settings_file"
	fi

	# Try live update
	if [[ -e "$config_path" ]]; then
		if ! update_stereo_delay_live "$delay_value"; then
			update_config
		fi
	fi
	echo "Stereo delay set to $delay_value ms"
	;;

*) # Show help in english
	echo "Usage: $0 {start|stop|status|get-model|set-model|get-strength|set-strength|get-gate-threshold|set-gate-threshold|get-gate-range|set-gate-range|...}"
	echo ""
	echo "Commands:"
	echo "  start                             Start the noise reduction services (GTCRN)"
	echo "  stop                              Stop the noise reduction services"
	echo "  status                            Check if the noise reduction is enabled or disabled"
	echo "  get-model                         Get current model (0=Simple/Low Latency, 1=Full Quality)"
	echo "  set-model <0|1>                   Set the model (0=Simple/Low Latency, 1=Full Quality)"
	echo "  get-strength                      Get current noise reduction strength (0.0-1.0)"
	echo "  set-strength <0.0-1.0>            Set noise reduction strength (live update)"
	echo "  get-gate-threshold                Get current gate filter threshold (dB)"
	echo "  set-gate-threshold <-60 to 0>     Set gate filter threshold in dB (live update)"
	echo "  get-gate-range                    Get current gate filter range (dB)"
	echo "  set-gate-range <-90 to 0>         Set gate filter range in dB (live update)"
	echo "  enable-bluetooth-autoswitch-to-headset  Enable automatic switching to Bluetooth headset profile"
	echo "  disable-bluetooth-autoswitch-to-headset Disable automatic switching to Bluetooth headset profile"
	echo "  status-bluetooth                  Check the status of the Bluetooth headset auto-switch"
	;;
esac
