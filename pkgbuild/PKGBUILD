# Maintainer: Bruno Goncalves <bigbruno@gmail.com>

pkgname=biglinux-noise-reduction-pipewire
pkgver=2.0.0
pkgrel=1
arch=('any')
license=('GPL-3.0-or-later')
url="https://github.com/biglinux/biglinux-noise-reduction-pipewire"
pkgdesc="AI-powered microphone noise reduction with GTK4/Libadwaita interface for PipeWire"

depends=(
    'gtcrn-ladspa'
    'pipewire'
    'swh-plugins'
    'python>=3.10'
    'python-numpy'
    'python-gobject'
    'python-cairo'
    'gtk4'
    'libadwaita'
    'gstreamer'
    'gst-plugins-base'
    'gst-plugins-good'
)

makedepends=('python-pip')

# This package provides a LADSPA host via PipeWire filter-chain
provides=('ladspa-host')

source=("git+https://github.com/biglinux/biglinux-noise-reduction-pipewire.git")
md5sums=('SKIP')

package() {
    # Determine source directory
    if [ -d "${srcdir}/${pkgname}/${pkgname}" ]; then
        InternalDir="${srcdir}/${pkgname}/${pkgname}"
    else
        InternalDir="${srcdir}/${pkgname}"
    fi

    # Install usr directory contents (binaries, icons, desktop file, etc.)
    if [ -d "${InternalDir}/usr" ]; then
        cp -r "${InternalDir}/usr" "${pkgdir}/"
    fi

    # Install Python package using pip
    cd "${InternalDir}"
    python -m pip install --no-deps --no-build-isolation --root="${pkgdir}" --prefix=/usr .

    # Clean up Python cache files
    find "${pkgdir}" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find "${pkgdir}" -name "*.pyc" -delete 2>/dev/null || true

    # Ensure binaries are executable
    chmod +x "${pkgdir}/usr/bin/big-microphone-noise-reduction" 2>/dev/null || true
    chmod +x "${pkgdir}/usr/bin/pipewire-noise-remove" 2>/dev/null || true
}
